# 3D Magnetic Field Viewer

Visualize electromagnetic field patterns generated by your circuit in real-time 3D, with export capabilities for Blender to analyze emergent behavior.

## Features

- **Real-time 3D visualization** using Three.js
- **Multiple visualization modes**:
  - Vector Field: Shows field direction and strength as arrows
  - Streamlines: Traces magnetic field lines
  - Magnitude Cloud: Particle-based intensity visualization
  - Combined: All modes together
- **Interactive controls**: Rotate, pan, zoom with mouse
- **Blender export**: JSON and CSV formats for advanced analysis
- **Configurable resolution**: Balance between detail and performance

## Quick Start

### Web Viewer

1. **Open the viewer**: Navigate to `3dfieldview.php` in your browser
2. **Configure grid settings**:
   - **Resolution**: 5-25 (higher = more detail, slower calculation)
   - **Grid Size**: 0.1m - 10m (size of calculation volume)
3. **Click "Calculate Field"** - This will:
   - Collect all magnetic components from your circuit
   - Calculate field at each grid point using Biot-Savart law
   - Apply Kunferman Buffer regularization to prevent singularities
4. **Visualize**: Choose display mode and adjust visual parameters
5. **Interact**:
   - Left drag: Rotate view
   - Right drag: Pan
   - Scroll: Zoom
   - Double-click: Reset view

### Visualization Modes Explained

#### Vector Field
Shows arrows at each grid point:
- **Arrow direction**: Magnetic field direction
- **Arrow length**: Logarithmic scale of field magnitude
- **Arrow color**: Blue (weak) → Red (strong)

Best for: Understanding overall field structure

#### Streamlines
Traces field lines through space:
- **Lines follow**: Magnetic field direction
- **Line color**: Based on starting point magnitude
- **Line density**: Indicates field strength

Best for: Identifying emergent patterns, field line topology

#### Magnitude Cloud
Particle system showing field strength:
- **Particle size**: Proportional to field magnitude
- **Particle color**: Blue (weak) → Red (strong)
- **Particle density**: Shows field concentration

Best for: Hotspot identification, field distribution

## Export for Blender

### Why Blender?

Blender's advanced rendering and physics simulation can reveal emergent electromagnetic patterns that are hard to see in real-time viewers. It's particularly good for:

- **Emergent behavior analysis**: Cycles rendering shows subtle field interactions
- **Animation**: Animate field evolution over time
- **Geometry nodes**: Create procedural visualizations based on field data
- **Physics simulation**: Particle systems following field lines

### Export Workflow

1. **Calculate field** in the web viewer
2. **Click "Export JSON"** or **"Export Vector Field (CSV)"**
   - **JSON**: Complete dataset with metadata (recommended)
   - **CSV**: Raw vector field data (for custom processing)

3. **Open Blender** (2.8+ recommended)
4. **Open the Blender script**:
   - Go to Scripting workspace
   - Open `blender_import_magnetic_field.py`
   - Or paste the script into a new text block

5. **Configure the script**:
   ```python
   FILE_PATH = "/path/to/your/magnetic_field_export.json"
   VISUALIZATION_MODE = 'curves'  # or 'arrows'
   ARROW_SCALE = 1.0
   SHOW_SOURCES = True
   ```

6. **Run script**: Press Alt+P or click Run Script

7. **View results**:
   - Press `Z` → "Rendered" for best visualization
   - Switch to "Shading" workspace for material editing
   - Use Cycles renderer for photorealistic field visualization

### Blender Visualization Modes

**Arrows Mode** (`VISUALIZATION_MODE = 'arrows'`)
- Creates actual 3D arrow meshes
- Best for print/publication quality images
- Configurable color mapping (magnitude or direction)
- Can be slow with high resolution (>15x15x15)

**Curves Mode** (`VISUALIZATION_MODE = 'curves'`)
- Traces streamlines as Bézier curves
- Excellent for identifying emergent patterns
- Natural, flowing visualization
- Great for animation

### Advanced Blender Techniques

#### Emergent Pattern Analysis

1. **Render with Cycles**:
   - Set render engine to Cycles
   - Add volumetric lighting
   - Use bloom and god rays for dramatic effect

2. **Geometry Nodes**:
   - Create instances along field lines
   - Vary object properties based on field magnitude
   - Generate procedural geometry from field data

3. **Animation**:
   - Export field at different time steps
   - Import sequentially
   - Animate field evolution
   - Use shape keys for morphing between states

4. **Particle Systems**:
   - Create particles following field lines
   - Use field magnitude for particle color/size
   - Simulate charged particle motion

## Technical Details

### Field Calculation

The viewer uses geodesic magnetic field calculations:

1. **Component Detection**: Scans circuit for magnetic sources (coils, solenoids, Helmholtz)
2. **Grid Generation**: Creates 3D grid of sample points
3. **Biot-Savart Integration**: For each source:
   ```
   B = (μ₀/4π) Σ (I·dl × r̂) / r²
   ```
4. **Kunferman Regularization**: Prevents singularities when r→0
   ```
   r_reg = √(r² + Δ²), where Δ ≈ 0.047
   ```
5. **Field Superposition**: Sum all source contributions

### Performance Tips

**Web Viewer:**
- Start with resolution = 10 for quick preview
- Increase to 15-20 for detailed analysis
- Use "Magnitude Cloud" for best performance
- Grid size should match your coil dimensions

**Blender:**
- Use 'curves' mode for high-resolution exports (20+)
- Use 'arrows' mode for lower resolution (10-15)
- Disable sources if you have many coils (>10)
- Consider decimating arrow count for massive datasets

### Data Format

**JSON Export Structure:**
```json
{
  "metadata": {
    "type": "magnetic_field_3d",
    "software": "ArtMag Electromagnetic Simulator",
    "timestamp": "ISO-8601",
    "resolution": 15,
    "bounds": { "xMin": -1, "xMax": 1, ... }
  },
  "sources": [
    {
      "type": "loop",
      "position": { "lat": 0, "lon": 0, "alt": 0 },
      "radius": 0.1,
      "current": 1.5
    }
  ],
  "field": [
    {
      "position": { "x": 0, "y": 0, "z": 0 },
      "field": { "x": 0, "y": 0, "z": 1e-5 },
      "magnitude": 1e-5
    }
  ]
}
```

**CSV Export Format:**
```
x,y,z,Bx,By,Bz,magnitude
-1.0,-1.0,-1.0,0.00001,0.00002,0.00003,0.00004
...
```

## Troubleshooting

### No field visible
- **Check circuit**: Ensure you have magnetic components (coils, solenoids) with current flowing
- **Increase grid size**: Field might be outside viewing volume
- **Increase color intensity**: Weak fields may not be visible at default settings
- **Check resolution**: Too low resolution might miss field details

### Calculation is slow
- **Reduce resolution**: Try 10 instead of 20
- **Reduce grid size**: Smaller volumes calculate faster
- **Fewer sources**: Each solenoid creates many field sources

### Blender import fails
- **Check file path**: Must be absolute path
- **Verify file format**: .json or .csv only
- **Check Blender version**: Script tested on Blender 2.8+
- **Enable Python console**: View → Toggle System Console for error messages

### Export files are huge
- **Reduce resolution**: Cubic relationship (15³ = 3,375 points!)
- **Use CSV instead of JSON**: More compact for raw data
- **Filter weak fields**: Edit export code to skip magnitude < threshold

## Example Use Cases

### Single Coil Analysis
- Resolution: 15
- Grid size: 0.5m
- Mode: Streamlines
- Look for: Dipole pattern, field line curvature

### Helmholtz Coil Uniformity
- Resolution: 20
- Grid size: Match coil separation
- Mode: Magnitude Cloud
- Look for: Uniform region between coils

### Multi-Coil Interference
- Resolution: 15-18
- Grid size: Enclose all coils
- Mode: Combined or Streamlines
- Look for: Constructive/destructive interference patterns, emergent field structures

### Solenoid Field Structure
- Resolution: 20
- Grid size: 2x solenoid length
- Mode: Streamlines + Arrows
- Look for: Uniform internal field, fringing at ends

## API Reference

### Grid Calculation Endpoint

```
GET /scripts/switch_fetch.php?action=calc_field_grid
```

**Parameters:**
- `resolution`: Integer 5-30 (default: 10)
- `xMin`, `xMax`: Float (default: -1, 1)
- `yMin`, `yMax`: Float (default: -1, 1)
- `zMin`, `zMax`: Float (default: -1, 1)
- `centerLat`, `centerLon`, `centerAlt`: Float (default: 0)

**Response:**
```json
{
  "grid": [/* array of field points */],
  "resolution": 15,
  "bounds": {/* grid bounds */},
  "sources": [/* source positions */],
  "totalPoints": 3375
}
```

## Future Enhancements

Potential additions:
- [ ] VDB format export for volumetric rendering
- [ ] Real-time field animation as circuit runs
- [ ] GPU-accelerated field calculation
- [ ] Field line topology analysis
- [ ] Magnetic potential visualization
- [ ] Force vector field for particle simulation
- [ ] Integration with FEM solvers
- [ ] VR/AR field visualization

## Credits

Built for the ArtMag Electromagnetic Simulator
Uses Kunferman Buffer regularization for singularity prevention
Based on Biot-Savart law and geodesic geometry

## License

Same as parent project
